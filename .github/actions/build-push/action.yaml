name: 'Build Push'
description: 'Builds and pushes a Docker image to GHCR.'
inputs:
  gh-token:
    description: 'PAT used for triggering workflows.'
    required: true
  cluster:
    description: 'The development cluster to target.'
    default: 'dev-1'
    required: false

runs:
  using: "composite"
  steps:

  - uses: docker/setup-buildx-action@v2

  - uses: docker/login-action@v2
    with:
      registry: ghcr.io
      username: '${{ github.actor }}'
      password: '${{ github.token }}'

  - uses: docker/metadata-action@v4
    id: meta
    with:
      images: ghcr.io/${{ github.repository }}
      flavor: latest=false
      tags: type=sha

  - uses: docker/build-push-action@v3
    with:
      context: .
      push: true
      tags: ${{ steps.meta.outputs.tags }}
      labels: ${{ steps.meta.outputs.labels }}

  - shell: bash
    env:
      GH_TOKEN: '${{ inputs.gh-token }}'
      GH_REPO: gramLabs/stormforge-app
    run: |
      gh workflow run 18788892 \
        --ref main \
        -f image="${{ steps.meta.outputs.tags }}" \
        -f cluster="${{ inputs.cluster }}"
